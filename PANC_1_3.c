#include <math.h>
#include <stdio.h>
#include <windows.h>
#include <stdlib.h>

#define samples 32000
#define M 5
#define N 5
#define mi 0.002

double Convolve(double *x, int sampleN, int flag){
/* Aweigthing */
double coef[7] = {0.422680750038023,	-0.845361500076049,	-0.422680750038021,	1.69072300015210,	-0.422680750038026,	-0.845361500076047,	0.422680750038024};
/* Primary Path - P(z) */
//double P[N] = {9.8751e-07,7.0555e-07,7.8867e-07,6.2727e-07,3.5926e-07,-2.8421e-07,-8.9977e-07,-1.0242e-06,-1.8151e-06,-1.1184e-06,-1.1212e-06,-1.251e-06,-1.1441e-06,-3.1542e-06,-1.1959e-06,-3.4317e-06,-2.3763e-06,-2.2613e-06,-4.3411e-06,6.5885e-07,-6.7738e-06,2.7046e-06,-4.8404e-06,-9.0445e-07,4.0685e-06,-1.19e-05,1.6499e-05,-1.9814e-05,2.0586e-05,-1.5053e-05,6.0385e-06,2.1352e-05,-6.5333e-05,0.0003126,-6.8226e-05,-0.00024206,0.00024452,-5.5717e-05,-3.6282e-05,9.0779e-06,-0.00013347,-7.9183e-05,-2.3781e-05,5.2672e-05,-3.1069e-05,4.4892e-05,0.00011396,-3.6903e-05,-2.511e-05,-7.7695e-05,-0.00013714,8.8419e-05,0.00025258,6.1949e-05,-0.0001049,-3.6614e-05,1.0689e-05,-3.5338e-05,-4.6979e-05,0.00015132,0.00016596,-6.5897e-05,-0.0002165,-0.00016783,0.00015448,8.4516e-05,-6.458e-05,3.1229e-05,-4.1038e-05,-0.00011839,-9.4258e-08,0.00015435,2.6244e-05,-0.00014516,-2.9886e-05,7.5265e-05,-4.6043e-06,5.7188e-05,9.0658e-05,-9.0986e-05,5.912e-06,9.9357e-05,-1.3123e-05,-7.2834e-05,-2.3117e-05,2.7744e-05,7.0399e-05,2.0007e-05,-5.3619e-05,-6.3821e-05,-3.5847e-05,4.7881e-06,-1.4449e-05,-9.9284e-06,-7.4869e-05,2.4735e-05,0.00012243,8.8798e-06,-3.1725e-06,3.7036e-05,-3.5756e-06,-6.8542e-05,-4.2458e-05,-9.5071e-06,3.0191e-05,5.7814e-05,2.229e-05,1.5498e-05,-4.3224e-06,-2.9088e-05,-4.0233e-05,-2.124e-05,3.8066e-05,1.6414e-05,1.3973e-05,1.8485e-05,-3.567e-05,-3.5842e-05,-4.1446e-06,2.2078e-05,3.1515e-05,1.0363e-05,-7.6561e-06,-4.937e-05,-9.1337e-06,2.4081e-05,-2.7127e-05,2.0421e-06,2.2337e-05,-2.8125e-05,4.5046e-07,-7.2942e-06,-2.8828e-05,4.9554e-05,4.1773e-05,2.5099e-05,3.3827e-05,-3.1575e-05,-2.7073e-05,-1.3126e-06,-8.8766e-06,-4.4375e-06,6.5923e-06,1.1488e-05,-1.0495e-05,-2.2639e-05,-7.9047e-06,-7.865e-06,-1.1224e-06,2.326e-05,-1.103e-05,4.7849e-06,8.9625e-06,-2.0342e-05,2.8251e-06,-1.1252e-06,3.8089e-05,-2.7466e-06,-3.4692e-05,3.859e-05,1.5791e-06,-1.877e-05,8.9083e-07,-2.8637e-06,9.9088e-06,-1.1027e-05,-4.1876e-06,-1.4268e-06,-1.8086e-06,7.2191e-06,4.4141e-06,1.0575e-05,-1.1231e-05,-1.9284e-06,-7.6257e-06,-1.3311e-05,4.173e-06,4.7755e-06,3.7187e-06,-2.278e-06,8.0104e-07,5.7205e-06,1.1663e-05,-8.1378e-06,-1.8211e-06,1.8331e-05,4.5672e-06,-2.8718e-06,-8.9761e-06,-8.2834e-06,1.035e-06,8.3864e-06,-5.8947e-06,-2.0893e-05,-8.4307e-06,1.0693e-05,1.9664e-05,6.0614e-06,-9.6582e-06,-1.0387e-05,-4.5651e-06,3.6248e-07,-1.6101e-06,5.3257e-06,3.0566e-06,-5.11e-06,3.9576e-06,9.2597e-06,8.0871e-06,-7.6832e-06,-1.1489e-05,7.4248e-08,5.3236e-06,6.9808e-06,4.871e-07,1.7589e-06,5.7711e-06,5.0515e-06,-3.3277e-06,-6.9537e-06,-2.4302e-06,-5.1529e-06,2.7306e-06,3.8246e-06,-5.0727e-06,-2.7216e-06,1.1142e-06,2.2056e-06,-6.43e-06,-6.5104e-06,-1.7853e-06,-5.0847e-06,-1.9895e-06,4.4509e-06,5.6851e-06,4.5254e-06,1.0091e-06,2.1635e-06,6.9172e-06,3.6002e-06,1.1777e-06,3.3872e-06,-4.8497e-06,-5.8214e-06,8.9116e-06,3.6843e-06,-8.2904e-06,-8.3351e-06,-4.4378e-06,4.2713e-06,3.7094e-06,-3.0939e-06,-3.6186e-06,-1.3481e-06,3.6554e-06,-7.8686e-08};
double P[N] = {0.0625, 0.125, 0.25, 0.5, 1}; //Primary path
/* Secondary Path - S(z) */
//double S[N] = {-4.5157e-06,-9.1864e-07,-4.8626e-06,-6.5974e-06,1.3257e-06,-1.4758e-05,9.0796e-06,-1.761e-05,1.666e-06,-2.89e-06,-1.9753e-05,2.6071e-05,-6.4278e-05,6.7556e-05,-0.00014414,0.00011147,0.00047778,-0.00032351,-9.0755e-05,5.3787e-05,-0.00024935,0.0002392,-9.1409e-06,-0.00013962,0.00026696,8.5093e-05,-7.7905e-05,-6.2705e-05,-0.00011857,-8.7992e-05,-1.364e-05,1.9299e-05,5.464e-05,-9.4917e-05,-9.6003e-05,0.00011552,4.655e-05,0.00012479,1.3701e-05,-4.5619e-05,1.1769e-05,-6.6882e-05,1.5545e-05,-3.0525e-05,8.2443e-06,7.2532e-05,-1.2093e-06,1.014e-05,-7.924e-08,2.9559e-06,-2.3023e-05,-1.4572e-05,0.0001154,1.3234e-05,-7.4377e-05,-2.0402e-05,-6.7858e-05,-0.0001185,-2.3288e-05,8.8074e-05,3.0454e-05,-8.8518e-06,2.0323e-06,-1.2033e-05,-6.32e-06,1.9819e-05,5.4911e-05,6.5381e-05,6.3978e-05,-2.991e-05,-5.6439e-05,5.0405e-06,-4.6005e-05,-6.5349e-05,-3.6918e-06,6.3897e-05,4.6625e-05,3.0543e-06,-6.6171e-06,-3.9276e-05,1.2587e-05,1.9035e-05,-7.9042e-05,9.6718e-06,2.8868e-05,-6.0459e-05,3.3075e-05,2.954e-05,-2.2435e-05,-7.3053e-06,-1.5718e-05,-2.7198e-05,-3.1416e-06,3.1736e-05,4.3198e-05,3.165e-05,4.0507e-05,1.8968e-05,-5.5417e-05,2.1791e-06,5.8225e-06,-3.157e-05,1.1093e-06,-1.1522e-06,2.753e-05,-1.5661e-05,-4.9932e-05,2.0152e-05,1.8701e-05,-1.3507e-06,-2.8258e-05,-1.2644e-05,6.9963e-05,-7.6224e-06,-4.9417e-05,5.1297e-06,-2.1123e-05,-3.0035e-05,-5.9017e-06,1.8466e-05,1.8473e-05,2.7227e-05,4.7105e-06,-1.0902e-05,2.9663e-05,2.8534e-05,1.2086e-05,-9.5528e-06,-1.347e-05,-4.9712e-06,-7.9699e-06,-7.4571e-06,-1.0358e-05,5.1196e-06,-1.006e-05,-2.1246e-05,2.2562e-06,-8.8022e-06,3.0947e-06,6.996e-06,-4.2686e-06,2.4205e-06,-7.9467e-06,1.252e-05,-7.5415e-06,9.1428e-06,3.3636e-05,-5.6817e-06,1.0206e-05,-6.7353e-06,-9.4919e-06,5.9364e-06,1.202e-06,1.9183e-05,-1.1434e-05,4.0671e-06,1.2983e-05,-2.1218e-05,-2.1494e-05,-1.8116e-05,1.6048e-06,7.187e-06,-1.3176e-07,-1.5349e-05,-1.1902e-05,2.1235e-05,8.7058e-06,1.1816e-06,4.388e-06,3.6494e-06,3.768e-06,-4.7254e-07,5.3145e-07,-4.5659e-06,-5.5274e-06,-3.1343e-06,7.5492e-06,5.3314e-06,-1.2257e-05,-3.9336e-06,4.7955e-06,1.1912e-05,2.1511e-05,1.0811e-05,-4.6352e-06,-1.1227e-05,-3.0817e-06,-7.123e-06,-8.1751e-06,-2.353e-07,-3.3013e-06,-5.6921e-06,-7.585e-06,1.8384e-06,1.9745e-06,-1.6146e-07,4.9641e-06,9.007e-07,4.5796e-06,5.1487e-06,-4.5984e-06,-3.9393e-06,-2.0571e-06,-1.762e-06,4.975e-06,7.0647e-06,1.1925e-07,-3.3527e-06,2.75e-06,7.4684e-06,-2.0138e-06,-7.6019e-06,-2.5348e-06,5.1038e-06,-1.0205e-06,-9.4024e-06,-1.5806e-06,3.6871e-06,3.7032e-07,-3.425e-06,-6.5236e-07,1.1511e-06,2.5538e-06,-1.5975e-06,-1.5685e-06,6.6366e-06,7.3574e-06,2.9049e-06,-6.5322e-07,3.9368e-06,1.7344e-06,-6.3399e-06,-2.7292e-06,3.2554e-06,2.5666e-06,-4.641e-06,-4.7889e-06,3.3013e-06,3.2345e-06,-2.2551e-06,-2.9592e-06,-7.8489e-06,-8.5771e-06,1.7816e-06,2.1833e-06,-1.4104e-06,-4.2597e-06,-4.6771e-06,1.7563e-06,4.125e-06,4.929e-06,7.9235e-06,9.2533e-06,2.4728e-06,-2.8278e-06,2.1486e-06};
double S[N] = {0.0125, 0.025, 0.05, 0.1, 0.2};
/* Filter length - for past samples */
int fl;
/* Output of Convolve function */
double y = 0;

switch(flag){
    /* Case 0 - A weigthing */
    case 0: 
    fl = 7; 

    for(int j=0;j<fl;j++){
        if((sampleN - j) >= 0){
        y += 0.2 * (x[sampleN - j] * coef[j]);
        }
    }

    break;

    /* Case 1 - Primary Path */
    case 1: 
    fl = N; 

    for(int j=0;j<fl;j++){
        if((sampleN - j) >= 0){
        y += (x[sampleN - j] * P[j]);
        }
    }

    break;

    /* Case 2 - Secondary Path */
    case 2: 
    fl = N; 

    for(int j=0;j<fl;j++){
        if((sampleN - j) >= 0){
        y += (x[sampleN - j] * S[j]);
        }
    }

    break;

    /* Passing samples */
    default:
        y = x[sampleN];
    break;

}

return y;
}


void DataGenerator(double *x, double *d){

 /* generate a random floating point number from min to max */
double min = -5;
double max =  5;
double range = (max - min); 
double div = RAND_MAX / range;


 for(int i=0;i<samples;i++){
    x[i] = min + (rand() / div);
}

 /* P(z) filtration  x -> d*/
for(int i=0;i<samples;i++){
    d[i] = Convolve(x,i,1);
}

}


void PANC(double *x, double *d, double *e, double *Yout){
/* Signals declaration */
double xs[samples] = {0.0};
double xh[samples] = {0.0};
double output[samples] = {0.0};
double eh[samples] = {0.0};
/* M length arrays for FxLMS parameters and adaptation/output inputs */
double X[M] = {0.0};
double Xh[M] = {0.0};
double W[M] = {0.0};


/* Iterating through all samples */
for(int i=0;i<samples;i++){

    /* Input signal X filtration through secondary path model */
    xs[i] = Convolve(x,i,2);

    /* Filtrated signal xs A-weigthing*/
    xh[i] = Convolve(xs,i,3);

    /* Adaptation input - storing M past samples */
    for(int j=i;j>(i-M);j--){
        if(j>=0){
            X[M + (j-i) - 1] = x[j];
            Xh[M + (j-i) - 1] = xh[j];
        }else{break;}
    }

    /* Calculating output based on raw input signal */
    for(int j=0;j<M;j++){
        Yout[i] +=(W[j]*X[j]); 
    }

    /* Output signal filtration through secondary path */
    output[i] = Convolve(Yout,i,2);

    /* Calculating error */
    e[i] = d[i] - output[i];

    /* Error signal A-weigthing */
    eh[i] = Convolve(e,i,3);

    /* Filter coefficients update */
    for(int j=0;j<M;j++){
        W[j] = W[j] + 2*(mi * eh[i] * Xh[j]);
    }


}
}

void main(){
double noise[samples] = {0.0};
double error[samples]= {0.0};
double desired[samples]= {0.0};
double Anoise[samples]= {0.0};   


DataGenerator(noise, desired);
PANC(noise,desired,error,Anoise);

/* Debbuging */
FILE *F;
F = fopen("KONT.csv", "w+");

for(int i=0;i<samples;i++){
    fprintf(F, "%d,%f,%f,%f,%f\n", i, noise[i], desired[i], error[i], Anoise[i]);
}
fclose(F);

}